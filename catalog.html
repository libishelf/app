<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LibiShelf + AWS S3 Catalog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- AWS CONFIGURATION ---
        const S3_BUCKET_NAME = "YOUR-BUCKET-NAME"; // Update this!
        const REGION = "us-east-1"; // Update this!
        
        const firebaseConfig = {
            apiKey: "AIzaSyBTVSCflCLlaacMplOxMa1HmRVYSg9WPBI",
            authDomain: "libishelf-38fa6.firebaseapp.com",
            projectId: "libishelf-38fa6",
            storageBucket: "libishelf-38fa6.firebasestorage.app",
            messagingSenderId: "778087006231",
            appId: "1:778087006231:web:a3ecf2304d82419926dc52",
            measurementId: "G-M08N81QJ35"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        async function start() {
            try {
                await signInAnonymously(auth);
                listenForBooks();
            } catch (err) {
                showStatus("Auth Error: Check Firebase.", "red");
            }
        }

        async function uploadToS3(file) {
            const cleanName = file.name.replace(/[^a-z0-9.]/gi, '_').toLowerCase();
            const fileName = `covers/${Date.now()}-${cleanName}`;
            const uploadUrl = `https://${S3_BUCKET_NAME}.s3.${REGION}.amazonaws.com/${fileName}`;

            try {
                const response = await fetch(uploadUrl, {
                    method: 'PUT',
                    body: file,
                    headers: { 'Content-Type': file.type }
                });

                if (!response.ok) throw new Error(`AWS Error: ${response.status}`);
                return uploadUrl;
            } catch (err) {
                console.error("Upload Error:", err);
                throw new Error("Failed to fetch: Check your AWS CORS settings.");
            }
        }

        window.addNewBook = async () => {
            const title = document.getElementById('bookTitle').value;
            const author = document.getElementById('bookAuthor').value;
            const file = document.getElementById('bookCover').files[0];
            const btn = document.getElementById('saveBtn');

            if (!title || !author) return showStatus("Title and Author required!", "red");

            btn.disabled = true;
            btn.innerText = "Connecting to AWS...";

            try {
                let imageUrl = "";
                if (file) {
                    imageUrl = await uploadToS3(file);
                }

                await addDoc(collection(db, "library_books"), {
                    title, author, cover: imageUrl, status: 'Available', createdAt: serverTimestamp()
                });

                showStatus("Saved! Check AWS Bucket now.", "green");
                document.getElementById('addBookForm').reset();
            } catch (e) {
                showStatus(e.message, "red");
            } finally {
                btn.disabled = false;
                btn.innerText = "Add Book";
            }
        };

        function listenForBooks() {
            onSnapshot(collection(db, "library_books"), (snapshot) => {
                const list = document.getElementById('bookTableBody');
                list.innerHTML = ''; 
                snapshot.forEach((doc) => {
                    const b = doc.data();
                    const img = b.cover ? `<img src="${b.cover}" class="w-12 h-16 object-cover rounded shadow border">` : `<div class="w-12 h-16 bg-gray-200 rounded flex items-center justify-center text-[8px] text-gray-400">No Image</div>`;
                    list.innerHTML += `
                        <tr class="border-b hover:bg-slate-50 transition-colors">
                            <td class="p-4">${img}</td>
                            <td class="p-4 font-semibold text-slate-800">${b.title}</td>
                            <td class="p-4 text-slate-600">${b.author}</td>
                            <td class="p-4"><span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-[10px] font-bold uppercase">Ready</span></td>
                        </tr>`;
                });
            });
        }

        function showStatus(msg, color) {
            const el = document.getElementById('statusBox');
            el.innerText = msg;
            el.className = `mb-4 p-4 rounded-xl text-sm font-bold bg-${color}-50 text-${color}-700 border border-${color}-200 block`;
        }

        start();
    </script>
</head>
<body class="bg-slate-50 min-h-screen p-8 font-sans">
    <div class="max-w-5xl mx-auto">
        <header class="mb-8 border-b border-slate-200 pb-6">
            <h1 class="text-3xl font-black text-slate-900 tracking-tight">AWS Integrated Catalog</h1>
            <p class="text-slate-500 mt-1">Files go to S3, Data goes to Firestore.</p>
        </header>
        <div id="statusBox" class="hidden"></div>
        <form id="addBookForm" onsubmit="event.preventDefault();" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div>
                <label class="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">Title</label>
                <input id="bookTitle" type="text" class="w-full border p-2.5 rounded-lg bg-slate-50 outline-none focus:ring-2 focus:ring-orange-500">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">Author</label>
                <input id="bookAuthor" type="text" class="w-full border p-2.5 rounded-lg bg-slate-50 outline-none focus:ring-2 focus:ring-orange-500">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">Cover (S3)</label>
                <input id="bookCover" type="file" accept="image/*" class="text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-orange-50 file:text-orange-700">
            </div>
            <button id="saveBtn" onclick="addNewBook()" class="bg-orange-600 text-white p-3 rounded-xl font-bold hover:bg-orange-700 transition shadow-lg active:scale-95">Add Book</button>
        </form>
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-slate-50 border-b">
                    <tr>
                        <th class="p-4 text-xs font-bold text-slate-400 uppercase">Cover</th>
                        <th class="p-4 text-xs font-bold text-slate-400 uppercase">Title</th>
                        <th class="p-4 text-xs font-bold text-slate-400 uppercase">Author</th>
                        <th class="p-4 text-xs font-bold text-slate-400 uppercase">Status</th>
                    </tr>
                </thead>
                <tbody id="bookTableBody"></tbody>
            </table>
        </div>
    </div>
</body>
</html>
