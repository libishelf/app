<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LibiShelf Library System</title>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1500.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card { @apply bg-white p-6 rounded-lg shadow-md border border-gray-200; }
        .book-item { @apply p-3 border-b last:border-0 hover:bg-gray-50 flex justify-between items-center; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">
    <div class="max-w-2xl mx-auto">
        <header class="mb-8 text-center md:text-left">
            <h1 class="text-3xl font-bold text-gray-800">LibiShelf</h1>
            <p class="text-gray-600">Your Personal Cloud Library</p>
        </header>

        <!-- Main App Panel -->
        <div id="app-panel" class="space-y-6">
            <!-- Add Book Form -->
            <div class="card">
                <h2 class="text-lg font-semibold mb-4 text-green-700">Add a New Book</h2>
                <div class="flex flex-col gap-4">
                    <input id="bookTitle" type="text" placeholder="Book Title" class="border p-2 rounded focus:ring-2 focus:ring-green-500 outline-none">
                    <input id="bookAuthor" type="text" placeholder="Author Name" class="border p-2 rounded focus:ring-2 focus:ring-green-500 outline-none">
                    <button onclick="uploadToS3()" class="bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700 transition">Save to LibiShelf</button>
                </div>
                <div id="status" class="mt-4 text-sm font-medium text-center"></div>
            </div>

            <!-- Library View -->
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-purple-700">Your Bookshelf</h2>
                    <button onclick="fetchLibrary()" class="text-sm text-blue-600 hover:underline font-medium">Refresh List</button>
                </div>
                <div id="book-list" class="min-h-[100px] border rounded bg-gray-50 overflow-hidden">
                    <!-- Books will appear here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Pre-filled credentials
        const AWS_CONFIG = {
            accessKeyId: "AKIAWFH3BVHOQPMLKDQF",
            secretAccessKey: "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",
            region: "us-east-1",
            bucketName: "libishelf"
        };

        // Initialize S3
        AWS.config.update({
            accessKeyId: AWS_CONFIG.accessKeyId,
            secretAccessKey: AWS_CONFIG.secretAccessKey,
            region: AWS_CONFIG.region
        });

        const s3 = new AWS.S3({ 
            params: { Bucket: AWS_CONFIG.bucketName },
            signatureVersion: 'v4' 
        });

        // Load library on start
        window.onload = fetchLibrary;

        async function uploadToS3() {
            const title = document.getElementById('bookTitle').value.trim();
            const author = document.getElementById('bookAuthor').value.trim();
            const status = document.getElementById('status');

            if (!title || !author) {
                status.innerText = "Please enter both title and author.";
                status.className = "mt-4 text-sm font-medium text-red-600";
                return;
            }

            const bookId = Date.now();
            const libraryData = {
                id: bookId,
                title: title,
                author: author,
                dateAdded: new Date().toLocaleDateString()
            };

            const params = {
                Key: `library/book-${bookId}.json`,
                Body: JSON.stringify(libraryData),
                ContentType: 'application/json'
            };

            status.innerText = "Saving...";
            status.className = "mt-4 text-sm font-medium text-blue-600";

            try {
                await s3.putObject(params).promise();
                status.innerText = "Success! Book saved.";
                status.className = "mt-4 text-sm font-medium text-green-600";
                document.getElementById('bookTitle').value = '';
                document.getElementById('bookAuthor').value = '';
                setTimeout(fetchLibrary, 1000);
            } catch (err) {
                status.innerText = "Error: " + err.message;
                status.className = "mt-4 text-sm font-medium text-red-600";
            }
        }

        async function fetchLibrary() {
            const listContainer = document.getElementById('book-list');
            listContainer.innerHTML = '<p class="text-gray-400 text-center py-8 italic text-sm">Loading your books...</p>';

            try {
                const data = await s3.listObjectsV2({ Prefix: 'library/' }).promise();
                const jsonFiles = (data.Contents || []).filter(obj => obj.Key.endsWith('.json'));

                if (jsonFiles.length === 0) {
                    listContainer.innerHTML = '<p class="text-gray-400 text-center py-8">Your bookshelf is empty.</p>';
                    return;
                }

                const bookPromises = jsonFiles.map(obj => 
                    s3.getObject({ Key: obj.Key }).promise()
                );

                const results = await Promise.all(bookPromises);
                const books = results.map(res => JSON.parse(res.Body.toString()));

                listContainer.innerHTML = '';
                books.sort((a, b) => b.id - a.id).forEach(book => {
                    const div = document.createElement('div');
                    div.className = 'book-item';
                    div.innerHTML = `
                        <div>
                            <div class="font-bold text-gray-800">${book.title}</div>
                            <div class="text-xs text-gray-500">by ${book.author}</div>
                        </div>
                        <div class="text-xs font-mono text-gray-400">${book.dateAdded}</div>
                    `;
                    listContainer.appendChild(div);
                });
            } catch (err) {
                listContainer.innerHTML = `<p class="text-red-500 text-center py-8">Access Error: ${err.message}</p>`;
            }
        }
    </script>
</body>
</html>
