<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up | LibiShelf</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            /* Path adjusted to look one level up for the background image */
            background: linear-gradient(rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.4)), url('../background.png') no-repeat center center fixed;
            background-size: cover;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">

    <div class="glass-panel w-full max-w-md rounded-3xl shadow-2xl p-8 border border-white/50">
        <!-- Logo -->
        <div class="text-center mb-8">
            <a href="../">
                <img src="../logo.svg" alt="LibiShelf" class="h-14 w-14 mx-auto mb-4">
            </a>
            <h1 id="step-title" class="text-2xl font-bold text-slate-800">Get Started</h1>
            <p id="step-sub" class="text-slate-500">Enter your school email to begin</p>
        </div>

        <!-- Step 1: Email -->
        <div id="step-1" class="space-y-4">
            <input type="email" id="email" placeholder="principal@yourschool.edu" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="goToStep2()" id="step1-btn" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition">Continue</button>
        </div>

        <!-- Step 2: School Info -->
        <div id="step-2" class="hidden space-y-4">
            <input type="text" id="school-name" placeholder="Full School Name" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none">
            <input type="text" id="school-address" placeholder="Street Address" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none">
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="city" placeholder="City" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none">
                <input type="text" id="state" placeholder="State" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none">
            </div>
            <input type="text" id="zip" placeholder="Zip Code" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none">
            <button onclick="goToStep3()" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200">Continue</button>
        </div>

        <!-- Step 3: Password -->
        <div id="step-3" class="hidden space-y-4">
            <input type="password" id="password" placeholder="Create Password" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none">
            <input type="password" id="confirm-password" placeholder="Confirm Password" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none">
            <button onclick="finishSignUp()" id="finish-btn" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200">Create Account</button>
        </div>

        <!-- Success Message -->
        <div id="success" class="hidden text-center space-y-4">
            <div class="text-6xl mb-4 animate-bounce">âœ¨</div>
            <h2 class="text-2xl font-bold text-slate-800">Account Created!</h2>
            <p class="text-slate-500">Your school's digital library is ready to go.</p>
            <a href="../login/" class="block w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-200">Go to Login</a>
        </div>

        <div id="error-msg" class="mt-4 text-red-500 text-sm text-center hidden font-medium"></div>

        <div class="text-center mt-6">
            <a href="../login/" class="text-sm text-slate-400 hover:text-blue-600">Already have an account? Sign In</a>
        </div>
    </div>

    <script>
        // Your specific API Gateway URL (make sure it ends with /auth if that's your resource)
        const API_URL = "https://1vs0akvj6e.execute-api.us-east-1.amazonaws.com/auth"; 

        let formData = {
            email: '',
            school_info: {}
        };

        function showStep(step) {
            ['step-1', 'step-2', 'step-3', 'success'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(step).classList.remove('hidden');
            
            const titles = {
                'step-1': ['Get Started', 'Enter your school email to begin'],
                'step-2': ['School Details', 'Tell us about your library'],
                'step-3': ['Secure Your Account', 'Create a strong password']
            };
            
            if (titles[step]) {
                document.getElementById('step-title').innerText = titles[step][0];
                document.getElementById('step-sub').innerText = titles[step][1];
            } else {
                document.getElementById('step-title').classList.add('hidden');
                document.getElementById('step-sub').classList.add('hidden');
            }
        }

        async function goToStep2() {
            const email = document.getElementById('email').value.trim();
            if(!email.includes('@')) return showError('Please enter a valid school email');
            
            const btn = document.getElementById('step1-btn');
            btn.innerText = "Checking...";
            btn.disabled = true;

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'check_email', email: email })
                });
                const data = await res.json();
                
                if(data.exists) {
                    showError('This email is already registered. Please login.');
                    btn.innerText = "Continue";
                    btn.disabled = false;
                } else {
                    formData.email = email;
                    showStep('step-2');
                    hideError();
                }
            } catch(e) { 
                showError('Could not connect to the server. Check your Internet.'); 
                btn.innerText = "Continue";
                btn.disabled = false;
            }
        }

        function goToStep3() {
            formData.school_info = {
                name: document.getElementById('school-name').value.trim(),
                address: document.getElementById('school-address').value.trim(),
                city: document.getElementById('city').value.trim(),
                state: document.getElementById('state').value.trim(),
                zip: document.getElementById('zip').value.trim()
            };
            if(!formData.school_info.name || !formData.school_info.city) return showError('Please fill in school name and city');
            showStep('step-3');
            hideError();
        }

        async function finishSignUp() {
            const pass = document.getElementById('password').value;
            const confirm = document.getElementById('confirm-password').value;
            if(pass !== confirm) return showError('Passwords do not match');
            if(pass.length < 6) return showError('Password must be at least 6 characters');

            const btn = document.getElementById('finish-btn');
            btn.innerText = "Saving Account...";
            btn.disabled = true;

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'register',
                        email: formData.email,
                        password: pass,
                        school_info: formData.school_info
                    })
                });
                
                if(res.ok) {
                    showStep('success');
                } else {
                    const d = await res.json();
                    showError(d.error || 'Registration failed');
                    btn.disabled = false;
                    btn.innerText = "Create Account";
                }
            } catch(e) { showError('Failed to connect to LibiShelf service'); }
        }

        function showError(msg) {
            const el = document.getElementById('error-msg');
            el.innerText = msg;
            el.classList.remove('hidden');
        }
        function hideError() { document.getElementById('error-msg').classList.add('hidden'); }
    </script>
</body>
</html>
